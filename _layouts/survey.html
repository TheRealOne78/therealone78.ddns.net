<!DOCTYPE html>
<html lang="ro" style="background-color:#303030; margin:0; padding:0;">
    <head>
        <meta name="robots" content="noindex">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="UTF-8">
        <script type="text/javascript" src="/resources/npm/node_modules/davidshimjs-qrcodejs/qrcode.min.js"></script>
        <link   type="text/css"        href="/resources/npm/node_modules/survey-core/defaultV2.min.css"  rel="stylesheet">
        <script type="text/javascript" src="/resources/npm/node_modules/survey-core/survey.core.min.js"></script>
        <script type="text/javascript" src="/resources/npm/node_modules/survey-core/themes/index.min.js"></script>
        <script type="text/javascript" src="/resources/npm/node_modules/survey-js-ui/survey-js-ui.min.js"></script>
    </head>


    <body style="background-color:#303030; margin:0; padding:0;">
        <div style="display: flex; justify-content: center;">
            <div id="qrcode" style="margin: 10px 0 0 0; padding:25px; border-radius:20px; background-color:#ffffff" ></div>
        </div><br>

        <style>
         @media screen and (max-width: 1125px) {
             #qrcode {
                 display: none;
             }
         }
        </style>

        <div id="surveyContainer"></div>


        <script>
        // Fetch the current URL dynamically
        const currentUrl = window.location.href;

        // Generate QR Code with the current URL
        const qrcode = new QRCode(document.getElementById("qrcode"), {
            text: currentUrl,
            width: 512,
            height: 512,
            typeNumber: 0, // This is for automatic type detection
            correctLevel: QRCode.CorrectLevel.H, // High error correction
            render: "svg" // Render the QR code as SVG
        });

        const SURVEY_ID = 1; //TODO

        function surveyComplete (survey) {
            const userId = /* ... Getting the user ID ... */
                survey.setValue("userId", userId);

            saveSurveyResults(
                "https://your-web-service.com/" + SURVEY_ID,
                survey.data
            )
        }

        function saveSurveyResults(url, json) {
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=UTF-8'
                },
                body: JSON.stringify(json)
            })
                .then(response => {
                    if (response.ok) {
                        // Handle success
                    } else {
                        // Handle error
                    }
                })
                .catch(error => {
                    // Handle error
                });
        }

        function alertResults (sender) {
            const results = JSON.stringify(sender.data);
            alert(results);
        }

        // Synchronously load the survey JSON
        const surveyJsonUrl = "survey-json/{{ page.json_survey }}";
        let surveyData = null;

        try {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", surveyJsonUrl, false);
            xhr.send();

            if (xhr.status === 200) {
                surveyData = JSON.parse(xhr.responseText); // Parse the JSON
            } else {
                console.error("Failed to load survey JSON:", xhr.status, xhr.statusText);
            }
        } catch (error) {
            console.error("Error loading survey JSON:", error);
        }

        if (surveyData) {
            // Initialize the survey
            const survey = new Survey.Model(surveyData);
            survey.applyTheme(SurveyTheme.DefaultDark);

            // Render the survey once the DOM is ready
            document.addEventListener("DOMContentLoaded", function () {
                survey.render(document.getElementById("surveyContainer"));
            });

            // Handle survey completion
            survey.onComplete.add(function (sender) {
                const results = JSON.stringify(sender.data);
                alert("Survey Results: " + results);
            });
        }

        </script>

    </body>
</html>
